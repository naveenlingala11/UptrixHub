<section class="chess-app">
    <h1>â™Ÿ Chess</h1>
    <div class="clock-bar">
        <div class="clock white">
            â™™ {{ whiteTime | date:'mm:ss':'UTC' }}
        </div>
        <div class="clock black">
            â™Ÿ {{ blackTime | date:'mm:ss':'UTC' }}
        </div>
    </div>
    <!-- ================= THEMES ================= -->
    <div class="theme-panel">
        <span class="theme-title">ğŸ¨ Theme</span>

        <div class="theme-buttons">
            <button *ngFor="let t of themes" class="ctrl-btn" [class.active]="theme === t.key"
                (click)="setTheme(t.key)">
                {{ t.label }}
            </button>
        </div>
    </div>

    <div class="chess-layout">

        <!-- â™™ White Captured -->
        <div class="captured white" *ngIf="showCaptured">
            <h3>White Lost (âˆ’{{ whiteMaterialLoss }})</h3>
            <div class="pieces">
                <span *ngFor="let p of capturedWhite">{{ pieceIcon(p) }}</span>
            </div>
        </div>

        <!-- BOARD -->
        <div class="board" [class.blurred]="aiThinking" [class.check]="isCheck" [class.checkmate]="isCheckmate"
            [attr.data-theme]="theme">
            <div class="row" *ngFor="let row of board; let r=index">
                <div class="cell" *ngFor="let cell of row; let c=index" [class.dark]="(r+c)%2===1"
                    [class.selected]="selected?.r===r && selected?.c===c" [class.move]="isPossibleMove(r,c)"
                    (click)="selectCell(r,c)" [class.last]="lastMove?.tr===r && lastMove?.tc===c">
                    <span *ngIf="cell" [class.white-piece]="cell.color==='WHITE'"
                        [class.black-piece]="cell.color==='BLACK'">
                        {{ pieceIcon(cell) }}
                    </span>
                </div>
            </div>
        </div>

        <!-- â™Ÿ Black Captured -->
        <div class="captured black" *ngIf="showCaptured">
            <h3>
                Black Lost
                <span class="material-badge">âˆ’{{ blackMaterialLoss }}</span>
            </h3>

            <div class="pieces black-pieces">
                <span *ngFor="let p of capturedBlack" class="captured-piece">
                    {{ pieceIcon(p) }}
                </span>
            </div>
        </div>

        <div class="mobile-captured" *ngIf="!showCaptured">
            <div class="row">
                <span *ngFor="let p of capturedWhite">{{ pieceIcon(p) }}</span>
            </div>
            <div class="row">
                <span *ngFor="let p of capturedBlack">{{ pieceIcon(p) }}</span>
            </div>
        </div>

        <button class="ctrl-btn" (click)="showCaptured = !showCaptured">
            ğŸ§© Captures
        </button>

        <div class="history-panel" (click)="showMoves = true">
            <h3>ğŸ“œ Moves</h3>
            <div class="moves-preview">
                {{ moveHistory.length }} moves
            </div>
        </div>
        <div class="moves-overlay" *ngIf="showMoves">
            <div class="moves-modal">
                <h2>ğŸ“œ Move History</h2>

                <div class="moves-list">
                    <div *ngFor="let m of moveHistory; let i=index">
                        <span class="move-no" *ngIf="i % 2 === 0">
                            {{ (i/2 + 1) | number:'1.0-0' }}.
                        </span>
                        <span class="move">{{ m }}</span>
                    </div>
                </div>

                <button class="ctrl-btn primary" (click)="showMoves = false">
                    Close
                </button>
            </div>
        </div>

    </div>

    <!-- PROMOTION -->
    <div class="promotion" *ngIf="promotingPawn">
        <button (click)="promote('Q')">â™•</button>
        <button (click)="promote('R')">â™–</button>
        <button (click)="promote('B')">â™—</button>
        <button (click)="promote('N')">â™˜</button>
    </div>

    <!-- ================= CONTROLS ================= -->
    <div class="controls">

        <div class="left-controls">
            <button class="ctrl-btn" (click)="undo()">â†© Undo</button>
            <button class="ctrl-btn" (click)="redo()">â†ª Redo</button>
            <button class="ctrl-btn danger" (click)="resetGame()">âŸ² Reset</button>
        </div>

        <div class="center-controls">
            <button class="ctrl-btn primary" (click)="showHint()">ğŸ’¡ Hint</button>
            <button class="ctrl-btn info" (click)="toggleHelp()">ğŸ“˜ Help</button>
        </div>

        <div class="right-controls">
            <button class="ctrl-btn" [class.active]="mode==='PVP'" (click)="mode='PVP'">
                ğŸ‘¥ PVP
            </button>
            <button class="ctrl-btn" [class.active]="mode==='PVC'" (click)="mode='PVC'">
                ğŸ¤– Vs AI
            </button>
        </div>
        <div class="difficulty-panel">

            <span class="difficulty-title">
                Difficulty:
                <strong>{{ difficultyLabel }}</strong>
            </span>

            <div class="difficulty-buttons">
                <button *ngFor="let d of difficultyLevels" class="ctrl-btn" [class.active]="difficulty === d.value"
                    (click)="setDifficulty(d.value)">
                    {{ d.label }}
                </button>
            </div>

        </div>

    </div>

    <!-- ================= HELP MODAL ================= -->
    <div class="help-overlay" *ngIf="showHelp">

        <div class="help-modal">

            <h2>â™Ÿ Chess â€“ How to Play</h2>

            <ul>
                <li>â™™ White always moves first</li>
                <li>â™œ Click a piece to see legal moves</li>
                <li>ğŸ’¡ Hint shows a suggested move</li>
                <li>ğŸ¤– Vs AI lets you play against system</li>
                <li>â†© Undo / â†ª Redo allowed anytime</li>
                <li>â± Game ends on checkmate or timeout</li>
            </ul>

            <h3>Controls</h3>
            <p>
                PVP â†’ Player vs Player<br>
                Vs AI â†’ Player vs System<br>
                Reset â†’ Restart match
            </p>

            <button class="ctrl-btn primary" (click)="toggleHelp()">
                Got it ğŸ‘
            </button>

        </div>
    </div>

    <p class="status" *ngIf="status">{{ status }}</p>
    <div class="result-overlay" *ngIf="gameOver">
        <div class="result-box">

            <ng-container *ngIf="status === 'CHECKMATE'">
                ğŸ† {{ winner }} Wins!
                <div class="sub">
                    âŒ {{ loser }} is Checkmated
                </div>
            </ng-container>

            <ng-container *ngIf="status === 'STALEMATE'">
                ğŸ¤ Draw
                <div class="sub">Stalemate</div>
            </ng-container>

            <button class="ctrl-btn primary" (click)="resetGame()">
                Play Again
            </button>
        </div>
    </div>

</section>

<div class="ai-overlay" *ngIf="aiThinking">
    <div class="ai-box">
        ğŸ¤– AI thinkingâ€¦
    </div>
</div>
<div class="fly-piece" *ngIf="flyingPiece">
    {{ flyingPiece.icon }}
</div>